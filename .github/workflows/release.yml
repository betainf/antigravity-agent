name: Release Build v2

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always

jobs:
  # Step 1: å…ˆåˆ›å»º Release
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
          else
            VERSION=$(node -p "require('./src-tauri/tauri.conf.json').version")
            TAG="v$VERSION"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: 'Antigravity Agent ${{ steps.version.outputs.tag }}'
          body: |
            ## ğŸš€ Antigravity Agent ${{ steps.version.outputs.tag }}

            ### ğŸ“¥ ä¸‹è½½å®‰è£…

            #### Windows
            - **å®‰è£…ç‰ˆ**ï¼ˆæ¨èï¼‰: `Antigravity Agent_${{ steps.version.outputs.version }}_x64-setup.exe` - æ”¯æŒè‡ªåŠ¨æ›´æ–°
            - **ä¾¿æºç‰ˆ**: `Antigravity-Agent-x86_64-Portable.zip` - è§£å‹å³ç”¨ï¼Œæ— éœ€å®‰è£…

            #### macOS
            - **Apple Silicon (M1/M2)**: `Antigravity Agent_${{ steps.version.outputs.version }}_aarch64.dmg`
            - **Intel Mac**: `Antigravity Agent_${{ steps.version.outputs.version }}_x86_64.dmg`

            #### Linux
            - **AppImage**: `antigravity-agent_${{ steps.version.outputs.version }}_amd64.AppImage` - é€šç”¨æ ¼å¼ï¼Œé€‚ç”¨äºæ‰€æœ‰å‘è¡Œç‰ˆ
            - **Debian/Ubuntu**: `antigravity-agent_${{ steps.version.outputs.version }}_amd64.deb`

            ---

            ### ğŸ“‹ æ›´æ–°æ—¥å¿—

            ${{ github.event.release.body || 'è¯·æŸ¥çœ‹ [æäº¤å†å²](https://github.com/${{ github.repository }}/commits/${{ steps.version.outputs.tag }}) è·å–è¯¦ç»†çš„æ›´æ–°å†…å®¹ã€‚' }}

            ---

            ### âœ¨ ä¸»è¦ç‰¹æ€§

            - ğŸ” **å¤šè´¦æˆ·ç®¡ç†**ï¼šè½»æ¾ç®¡ç†å’Œåˆ‡æ¢å¤šä¸ª Antigravity è´¦æˆ·
            - ğŸ“¦ **ä¸€é”®å¤‡ä»½**ï¼šè‡ªåŠ¨å¤‡ä»½è´¦æˆ·é…ç½®ï¼Œæ”¯æŒåŠ å¯†å¯¼å‡º
            - ğŸ”„ **å¿«é€Ÿåˆ‡æ¢**ï¼šä¸€é”®åˆ‡æ¢è´¦æˆ·ï¼Œè‡ªåŠ¨é‡å¯åº”ç”¨
            - ğŸ¯ **è·¨è®¾å¤‡åŒæ­¥**ï¼šåŠ å¯†é…ç½®æ–‡ä»¶ï¼Œå®‰å…¨åˆ†äº«åˆ°å…¶ä»–è®¾å¤‡
            - ğŸ’¾ **æ™ºèƒ½ç›‘æ§**ï¼šå®æ—¶ç›‘æ§æ•°æ®åº“å˜åŒ–ï¼Œè‡ªåŠ¨åŒæ­¥æ›´æ–°
            - ğŸ–¥ï¸ **ç³»ç»Ÿé›†æˆ**ï¼šåŸç”Ÿç³»ç»Ÿæ‰˜ç›˜æ”¯æŒï¼Œåå°é™é»˜è¿è¡Œ

            ---

            ### ğŸ”§ æŠ€æœ¯è§„æ ¼

            - åŸºäºæœ€æ–°ç‰ˆæœ¬çš„ Tauri æ¡†æ¶
            - åŸç”Ÿæ€§èƒ½ï¼Œè½»é‡çº§è®¾è®¡
            - è·¨å¹³å°æ”¯æŒï¼ˆWindowsã€macOSã€Linuxï¼‰
            - ç«¯åˆ°ç«¯åŠ å¯†ä¿æŠ¤æ•°æ®å®‰å…¨

            ---

            ğŸ™ **æ„Ÿè°¢ä½¿ç”¨ Antigravity Agentï¼**

            å¦‚æœè§‰å¾—è¿™ä¸ªå·¥å…·æœ‰ç”¨ï¼Œè¯·ç»™æˆ‘ä»¬ä¸€ä¸ª â­ï¸ æ¥æ”¯æŒæˆ‘ä»¬çš„å¼€å‘å·¥ä½œã€‚

            é‡åˆ°é—®é¢˜ï¼Ÿ[æäº¤ Issue](https://github.com/${{ github.repository }}/issues/new)
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Step 2: å¹¶è¡Œæ„å»ºå’Œä¸Šä¼ 
  build:
    needs: prepare-release
    uses: ./.github/workflows/tauri-build.yml
    with:
      tag: ${{ needs.prepare-release.outputs.tag }}
      ref: ${{ github.ref }}
      version: ${{ needs.prepare-release.outputs.version }}
      cache_key_suffix: release
    secrets: inherit

  # Step 3: è§¦å‘ updater
  trigger-updater:
    needs: [prepare-release, build]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Generate updater configuration
        uses: peter-evans/repository-dispatch@v2
        with:
          event-type: generate-updater
          client-payload: '{"tag": "${{ needs.prepare-release.outputs.tag }}"}'
