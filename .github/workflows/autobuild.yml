name: AutoBuild

on:
  push:
    branches: [dev]         # dev åˆ†æ”¯ push æ—¶è§¦å‘
  schedule:
    - cron: '0 0 * * *'    # æ¯å¤© 00:00 UTC æ„å»ºä¸€æ¬¡ Nightly
  workflow_dispatch:        # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸åˆ›å»º/æ›´æ–° releaseã€ä¸Šä¼ æ–‡ä»¶

concurrency:
  group: autobuild-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  # ç¬¬ä¸€æ­¥ï¼šåˆ é™¤æ—§ releaseï¼Œåˆ›å»ºæ–°çš„ release
  prepare-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Delete old autobuild release (if exists)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å°è¯•åˆ é™¤æ—§çš„ release
          gh release delete autobuild --yes --repo "${{ github.repository }}" 2>/dev/null || echo "No existing release to delete"
          # å°è¯•åˆ é™¤æ—§çš„ tag
          gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/autobuild" 2>/dev/null || echo "No existing tag to delete"
          echo "âœ… Cleaned up old release and tag"

      - name: Create new autobuild release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: autobuild
          name: 'Antigravity Agent Nightly (${{ github.event.head_commit.timestamp }})'
          body: |
            Nightly build from dev branch.

            ğŸ• Last updated: ${{ github.event.head_commit.timestamp }}
            ğŸ“¦ Commit: ${{ github.sha }}

            ---
            ## ğŸ“¥ ä¸‹è½½å®‰è£…

            âš ï¸ **æ³¨æ„**ï¼šè¿™æ˜¯è‡ªåŠ¨æ„å»ºçš„æµ‹è¯•ç‰ˆæœ¬ï¼Œå¯èƒ½ä¸ç¨³å®šã€‚å»ºè®®æ™®é€šç”¨æˆ·ä½¿ç”¨ [æ­£å¼å‘å¸ƒç‰ˆæœ¬](https://github.com/MonchiLin/antigravity-agent/releases/latest)ã€‚

            ### VS Code æ’ä»¶
            - [ğŸ‘‰ VSIXæ’ä»¶å®‰è£…åŒ… (Nightly)](${{ github.server_url }}/${{ github.repository }}/releases/download/autobuild/antigravity-vscode-nightly.vsix)
            
            ### Windows
            - **å®‰è£…ç‰ˆ**ï¼ˆæ¨èï¼‰: [Antigravity.Agent_x64-setup.exe](${{ github.server_url }}/${{ github.repository }}/releases/download/autobuild/Antigravity.Agent_x64-setup.exe) - æ”¯æŒè‡ªåŠ¨æ›´æ–°
            - **ä¾¿æºç‰ˆ**: [Antigravity-Agent-x86_64-Portable.zip](${{ github.server_url }}/${{ github.repository }}/releases/download/autobuild/Antigravity-Agent-x86_64-Portable.zip) - è§£å‹å³ç”¨ï¼Œæ— éœ€å®‰è£…
            
            ### macOS
            - **Apple Silicon (M1/M2)**: [Antigravity.Agent_aarch64.dmg](${{ github.server_url }}/${{ github.repository }}/releases/download/autobuild/Antigravity.Agent_aarch64.dmg)
            - **Intel Mac**: [Antigravity.Agent_x86_64.dmg](${{ github.server_url }}/${{ github.repository }}/releases/download/autobuild/Antigravity.Agent_x86_64.dmg)
            
            ### Linux
            - **AppImage**: [antigravity-agent_amd64.AppImage](${{ github.server_url }}/${{ github.repository }}/releases/download/autobuild/antigravity-agent_amd64.AppImage) - é€šç”¨æ ¼å¼ï¼Œé€‚ç”¨äºæ‰€æœ‰å‘è¡Œç‰ˆ
            - **Debian/Ubuntu**: [antigravity-agent_amd64.deb](${{ github.server_url }}/${{ github.repository }}/releases/download/autobuild/antigravity-agent_amd64.deb)
            ---

            ğŸ› å¦‚æœå‘ç°é—®é¢˜æˆ–è€…éœ€æ±‚è¯·æ±‚ï¼Œè¯·[æäº¤ Issue](https://github.com/MonchiLin/antigravity-agent/issues/new)
          prerelease: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¬¬äºŒæ­¥ï¼šå¹¶è¡Œæ„å»º
  build:
    needs: prepare-release
    uses: ./.github/workflows/tauri-build.yml
    with:
      tag: autobuild
      ref: dev
      cache_key_suffix: autobuild
    secrets: inherit

  # ç¬¬ä¸‰æ­¥ï¼šæ„å»º VS Code æ’ä»¶
  build-extension:
    needs: prepare-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: vscode-extension/package-lock.json

      - name: Install Root Dependencies
        run: npm ci --ignore-scripts --no-audit --prefer-offline

      - name: Get Version
        id: version
        working-directory: ./vscode-extension
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“ Using extension version $VERSION"

      - name: Install dependencies
        working-directory: ./vscode-extension
        run: npm ci

      - name: Build and Package Extension (Nightly)
        working-directory: ./vscode-extension
        # ä½¿ç”¨å›ºå®šåç§°ä»¥ä¾¿ release è¯´æ˜ä¸­çš„é“¾æ¥æ°¸ä¹…æœ‰æ•ˆ
        run: npx @vscode/vsce package --out ./antigravity-vscode-nightly.vsix

      - name: Upload Extension to Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload autobuild vscode-extension/antigravity-vscode-nightly.vsix --clobber --repo "${{ github.repository }}"

      - name: Publish to Open VSX
        # ä»…å½“ç‰ˆæœ¬å·å˜æ›´æ—¶æ‰å°è¯•å‘å¸ƒï¼Œé¿å…é‡å¤å‘å¸ƒç›¸åŒç‰ˆæœ¬æŠ¥é”™
        working-directory: ./vscode-extension
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          if [ -z "$OVSX_PAT" ]; then
            echo "âš ï¸ OVSX_PAT secret not found, skipping Open VSX publish"
            exit 0
          fi

          PACKAGE_NAME="MonchiLin.antigravity-vscode"
          echo "ğŸ” Checking Open VSX version for $PACKAGE_NAME..."
          
          # Fetch remote info, mute stderr in case it doesn't exist
          REMOTE_INFO=$(npx ovsx get "$PACKAGE_NAME" 2>/dev/null || echo "")
          
          if [ -z "$REMOTE_INFO" ]; then
             echo "âš ï¸ Package not found on Open VSX. Assuming first publish."
             REMOTE_VERSION="0.0.0"
          else
             # Extract version from output like "Version: 1.2.3"
             REMOTE_VERSION=$(echo "$REMOTE_INFO" | grep -i "Version:" | awk '{print $2}' | tr -d '[:space:]')
          fi
          
          echo "ğŸ”¹ Local Version: $VERSION"
          echo "ğŸ”¹ Remote Version: $REMOTE_VERSION"
          
          if [ "$VERSION" != "$REMOTE_VERSION" ]; then
            echo "ğŸš€ Versions differ. Publishing $VERSION..."
            # æ³¨æ„ï¼šOpen VSX å‘å¸ƒéœ€è¦æ ‡å‡†çš„ç‰ˆæœ¬å·æ–‡ä»¶åï¼Œè™½ç„¶æˆ‘ä»¬ä¸Šä¼  Release ç”¨äº† nightly åï¼Œ
            # ä½†ä¸ºäº†å‘å¸ƒå‘½ä»¤å¯èƒ½éœ€è¦é‡æ–°é‡å‘½åæˆ–è€…ç›´æ¥æŒ‡å®šæ–‡ä»¶ã€‚ovsx publish æ¥å—æ–‡ä»¶åã€‚
            npx ovsx publish ./antigravity-vscode-nightly.vsix --pat "$OVSX_PAT"
          else
            echo "âœ¨ Version $VERSION already exists on Open VSX. Skipping publish."
          fi
