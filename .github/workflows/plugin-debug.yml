name: Plugin Debug Build

on:
  push:
    branches: [plugin]      # plugin åˆ†æ”¯ push æ—¶è§¦å‘
  workflow_dispatch:        # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸åˆ›å»º/æ›´æ–° releaseã€ä¸Šä¼ æ–‡ä»¶

concurrency:
  group: plugin-debug-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  # ç¬¬ä¸€æ­¥ï¼šåˆ é™¤æ—§ releaseï¼Œåˆ›å»ºæ–°çš„ release
  prepare-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout plugin branch
        uses: actions/checkout@v4
        with:
          ref: plugin

      - name: Delete old plugin-debug release (if exists)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å°è¯•åˆ é™¤æ—§çš„ release
          gh release delete plugin-debug --yes --repo "${{ github.repository }}" 2>/dev/null || echo "No existing release to delete"
          # å°è¯•åˆ é™¤æ—§çš„ tag
          gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/plugin-debug" 2>/dev/null || echo "No existing tag to delete"
          echo "âœ… Cleaned up old release and tag"

      - name: Create new plugin-debug release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: plugin-debug
          name: 'Antigravity Agent Plugin Debug (${{ github.event.head_commit.timestamp }})'
          body: |
            Debug build from plugin branch.
            
            **åŒ…å« VS Code æ’ä»¶æ„å»º**

            ğŸ• Last updated: ${{ github.event.head_commit.timestamp }}
            ğŸ“¦ Commit: ${{ github.sha }}

            ---
            ## ğŸ“¥ ä¸‹è½½åœ°å€

            âš ï¸ **æ³¨æ„**ï¼šè¿™æ˜¯å¼€å‘è°ƒè¯•ç‰ˆæœ¬ï¼Œæå…¶ä¸ç¨³å®šã€‚

            ### VS Code æ’ä»¶
            - [VSIXå®‰è£…åŒ…](${{ github.server_url }}/${{ github.repository }}/releases/download/plugin-debug/antigravity-vscode-0.0.1.vsix)

            ### Windows
            **å®‰è£…ç‰ˆ(æ¨è)**
            - [64ä½(x64)](${{ github.server_url }}/${{ github.repository }}/releases/download/plugin-debug/Antigravity.Agent_x64-setup.exe)

            ### macOS
            - [Apple MèŠ¯ç‰‡](${{ github.server_url }}/${{ github.repository }}/releases/download/plugin-debug/Antigravity.Agent_aarch64.dmg) | [IntelèŠ¯ç‰‡](${{ github.server_url }}/${{ github.repository }}/releases/download/plugin-debug/Antigravity.Agent_x86_64.dmg)

            ### Linux
            **AppImage(é€šç”¨ æ¨è)**
            - [64ä½](${{ github.server_url }}/${{ github.repository }}/releases/download/plugin-debug/antigravity-agent_amd64.AppImage)
            ---
          prerelease: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¬¬äºŒæ­¥ï¼šå¹¶è¡Œæ„å»ºä¸»åº”ç”¨
  build-app:
    needs: prepare-release
    uses: ./.github/workflows/tauri-build.yml
    with:
      tag: plugin-debug
      ref: plugin
      cache_key_suffix: plugin-debug
    secrets: inherit

  # ç¬¬ä¸‰æ­¥ï¼šæ„å»º VS Code æ’ä»¶
  build-extension:
    needs: prepare-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: plugin

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: vscode-extension/package-lock.json

      - name: Install dependencies
        working-directory: ./vscode-extension
        run: npm ci

      - name: Build and Package Extension
        working-directory: ./vscode-extension
        run: npx @vscode/vsce package --out ./antigravity-vscode-0.0.1.vsix

      - name: Upload Extension to Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload plugin-debug vscode-extension/antigravity-vscode-0.0.1.vsix --clobber --repo "${{ github.repository }}"

      - name: Publish to Open VSX
        working-directory: ./vscode-extension
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
        run: |
          if [ -n "$OVSX_PAT" ]; then
            npx ovsx publish ./antigravity-vscode-0.0.1.vsix --pat "$OVSX_PAT"
          else
            echo "âš ï¸ OVSX_PAT secret not found, skipping Open VSX publish"
          fi
